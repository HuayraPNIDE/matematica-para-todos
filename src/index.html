<!doctype html>
<html>
    <head>
        <script src="./js/socket.io/socket.io-1.2.0.js"></script>
        <title>Matematica para todos - MXT</title>

        <link href="css/bootstrap.min.css" media='screen' rel="stylesheet" />
        <link href="css/style.css" media='screen' rel="stylesheet" />
        
        <script src="js/jquery-1.11.3.min.js"></script>
        <script src="js/bootstrap.min.js" type="text/javascript"></script>
        <script>
            var usuario_info = {};
            function init() {
                var local_ip = require('my-local-ip')()
                var socket = io("http://" + local_ip + ":3000/", {query: "nombre_jugador=jugador1"});
                registrar_espera(socket);
                buscar_amigos();
            }

            function elegir_amigo(amigo_ip) {
                //var amigo = document.getElementById('amigo').value;
                var socket = io("http://" + amigo_ip + ":3000", {query: "nombre_jugador=" + usuario_info.nombre});
                registrar_espera(socket);
            }

            function registrar_espera(socket) {
                socket.on('connect', function () {
                    console.log('Me conecte al servidor');
                    console.log('Registro eventos:\nlisto\nretiro\nmano');

                    socket.on('listo', function (o) {
                        document.getElementById("mazos").style.display = "block";
                        document.getElementById("lista_amigos").style.visibility = "hidden";
                        document.getElementById('btn_actualizar_amigos').style.visibility = "hidden";

                        document.getElementById("opcion_jugador1").value = "jugador1";
                        document.getElementById("opcion_jugador2").value = "jugador2";

                        document.getElementById('titulo').innerHTML = 'Arranca el juego';
                        //document.getElementById('nombres').innerHTML = arr[0]+' VS. '+arr[1];
                    });

                    socket.on('retiro', function (msg) {
                        document.getElementById('titulo').innerHTML = msg + ' Se retiro <br> Es el fin del juego';
                        document.getElementById("mazos").style.visibility = "hidden";
                        document.getElementById("opciones").style.visibility = "hidden";
                        document.getElementById("cartas").style.visibility = "hidden";
                        document.getElementById('nombres').innerHTML = "";
                        socket.disconnect();
                    });

                    socket.on('fin', function (resultados) {
                        document.getElementById('titulo').innerHTML = 'Es el fin del juego <br> Estos son los resultados';
                        document.getElementById("mazos").style.visibility = "hidden";
                        document.getElementById("opciones").style.visibility = "hidden";
                        document.getElementById("cartas").style.visibility = "hidden";

                        //document.getElementById('resultados').innerHTML = resultados;
                        socket.disconnect();
                    });

                    var btn_mano = document.getElementById('btn_mano');
                    socket.on('mano', function (o) {
                        console.log('Desde el server me llegan cartas:');
                        console.log(JSON.stringify(o, null, 2));
                        document.getElementById('cont_jugador1').innerHTML = o.contador_jugador1;
                        document.getElementById('cont_jugador2').innerHTML = o.contador_jugador2;
                        document.getElementById('cont_guerra').innerHTML = o.contador_guerra;
                        document.getElementById('carta1_img').src = o.carta1.img;
                        document.getElementById('carta2_img').src = o.carta2.img;
                        document.getElementById("cartas").style.display = "block";
                        document.getElementById("opciones").style.display = "block";
                        btn_mano.disabled = false;

                    });

                    btn_mano.onclick = function () {
                        console.log('Respondo');
                        var eleccion = document.getElementsByName("opcion");
                        var val = "";
                        for (var j = 0; j < eleccion.length; j++) {
                            if (eleccion[j].checked) {
                                val = eleccion[j].value;
                            }
                        }
                        socket.emit('respuesta', val);
                        btn_mano.disabled = true;
                    };

                });
            }

            var amigos = {};
            function buscar_amigos() {
                var spawn = require('child_process').spawn;
                var proceso = spawn("avahi-browse", ['-a', '-r', '-p', '--ignore-local']);
                var data = '';
                var lineas;

                proceso.stdout.on("data", function (chunk) {
                    lineas = ("" + chunk).split("\n");
                    for (i = 0; lineas.length > i; i++) {
                        if (/huayra_mxt/.test(lineas[i])) {
                            campos = lineas[i].split(";");

                            // tipo
                            if (campos[0] == '=') {
                                ip = campos[3].split('-')[1].replace(/\\/gi, "");
                                nombre = campos[3].split('-')[2];
                                amigos[ip] = nombre;
                            }

                            if (campos[0] == '-') {
                                ip = campos[3].split('-')[1].replace(/\\/gi, "");
                                delete amigos[ip];
                            }
                        }
                    }
                });
            }

            function actualizar_amigos() {
                e = $("<div></div>");
                for (var k in amigos) {
                    amigo = amigos[k];
                    tmp = '<div class="media thumbnail" data-ip="' + k + '"> \
                      <div class="media-left"><a href="#"><img class="media-object" src="img/avatar-neutro.png" width="81" height="86"></a></div> \
                      <div class="media-body"><h4 class="media-heading">' + amigos[k] + '</h4></div> \
                    </div>';

                    $(e).append($(tmp).on('click', function() {
//                        self.elegir($(this).data('ip'), cliente.nombre);
                        elegir_amigo(k);
                    }));
                }
                $('#lista_amigos').html(e);
                $('#lista_amigos').show();
            }
            
            function set_usuario_info() {
                usuario_info['nombre'] = document.getElementById('nombre').value;

                //Hago aparecer listado de amigos
                $("#avatar").hide();
                $("#btn_actualizar_amigos, #lista_amigos").show();
            }

        </script>
        <link href="css/style.css" media='screen' rel="stylesheet" />

    </head>
    <body onload="init()">
        <div id="container">
            <header>
                <h1>La Guerra de los Lados</h1>
                <h2 id="titulo"></h2>
            </header>

            <div id="avatar">
                <section class="row">
                    <div class="col-xs-6 col-sm-4"></div>
                    <div class="col-xs-6 col-sm-4 centro">
                        <div class="thumbnail">
                            <img src="img/avatar-neutro.png" alt="Usuario" />
                            <div class="caption">
                                <div class="form-group">
                                    <input name="nombre" id="nombre" type="text" class="form-control" placeholder="Ingrese un nombre de usuario.">
                                </div>
                                <p><a href="#" id="entrar" class="btn btn-primary" role="button">Entrar</a></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-6 col-sm-4"></div>
                </section>
            </div>
            

            <div id="mazos">
                <div id="mazo1"><div id="cont_jugador1">0</div><img src="res/imgs/lomo.png" /></div>
                <div id="cont_guerra"></div>
                <div id="mazo2"><div id="cont_jugador2">0</div><img src="res/imgs/lomo.png" /></div>
            </div>


            <p id="nombres"></p>

            <div id="opciones">
                <input name="opcion" type="radio" value="0" id="opcion_jugador1">Jugador 1<br>
                <input name="opcion" type="radio" value="1" id="opcion_jugador2">Jugador 2<br>
                <input name="opcion" type="radio" value="empate">EMPATE<br>
                <input type="button" value="Responder" id="btn_mano">
            </div>

            <div id="cartas">
                <div id="carta1"><img id="carta1_img"/></div>
                <div id="carta2"><img id="carta2_img"/></div>
            </div>
            
            <p><a href="#" class="btn btn-primary" id="btn_actualizar_amigos" role="button">Actualizar</a></p>
            <div id="lista_amigos"></div>
        </div>
        <script>
            $(document).ready(function() {
                $("#entrar").on("click", function(event) {
                    event.stopPropagation();
                    set_usuario_info();
                });
                
                $("#btn_actualizar_amigos").on("click", function(event) {
                    event.stopPropagation();
                    actualizar_amigos()
                });
            });
        </script>
    </body>
</html>
